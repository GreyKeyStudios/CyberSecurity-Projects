# Malware Containment Playbook

## Purpose
This playbook provides step-by-step procedures for SOC analysts to respond to malware detections on endpoints, including containment, investigation, and remediation.

## Prerequisites
- Access to EDR/antivirus console
- Access to endpoint management tools
- Access to threat intelligence tools
- Access to SIEM/logging systems
- Network isolation capabilities

---

## Triage Steps

### 1. Initial Assessment (5 minutes)
- [ ] Review EDR/antivirus alert
- [ ] Identify affected endpoint(s)
- [ ] Check file hash and detection name
- [ ] Determine initial severity
- [ ] Verify if malware executed

**Severity Guidelines:**
- **Critical:** Active malware, data exfiltration, lateral movement
- **High:** Malware executed, network connections established
- **Medium:** Malware detected but blocked
- **Low:** Suspicious file, not executed

### 2. Alert Details Review
- [ ] Extract file hash (MD5, SHA1, SHA256)
- [ ] Identify file path and name
- [ ] Check detection engine and confidence
- [ ] Review behavioral indicators
- [ ] Check user account that executed file
- [ ] Verify detection time

---

## Investigation Steps

### 3. File Analysis
- [ ] Submit file hash to VirusTotal
- [ ] Check file reputation
- [ ] Review file metadata
- [ ] Analyze file type and size
- [ ] Check for known malware family
- [ ] Document findings

### 4. Endpoint Investigation
- [ ] Review endpoint logs for:
  - Process creation
  - Network connections
  - File system modifications
  - Registry changes
  - Scheduled tasks
- [ ] Check for persistence mechanisms
- [ ] Review user account activity
- [ ] Check for lateral movement indicators

### 5. Network Analysis
- [ ] Identify C2 (Command & Control) IPs/domains
- [ ] Check network connection logs
- [ ] Verify if connections were established
- [ ] Check DNS queries
- [ ] Review firewall logs
- [ ] Submit IOCs to threat intelligence

### 6. Scope Assessment
- [ ] Check if other endpoints are affected
- [ ] Review network logs for related activity
- [ ] Check for data exfiltration
- [ ] Verify if lateral movement occurred
- [ ] Assess potential impact

---

## Containment Steps

### 7. Immediate Isolation
- [ ] Isolate endpoint from network
- [ ] Disable network adapter (if needed)
- [ ] Quarantine malicious file
- [ ] Terminate malicious processes
- [ ] Block C2 IPs/domains at firewall
- [ ] Document isolation actions

### 8. Network Blocking
- [ ] Block C2 IPs at firewall
- [ ] Block malicious domains (DNS sinkhole)
- [ ] Update threat intelligence feeds
- [ ] Block file hashes
- [ ] Notify security team

### 9. Endpoint Containment
- [ ] Disable affected user account (if compromised)
- [ ] Review and remove persistence mechanisms
- [ ] Check for scheduled tasks
- [ ] Review startup programs
- [ ] Document containment actions

---

## Remediation Steps

### 10. Malware Removal
- [ ] Run full system scan
- [ ] Remove malicious files
- [ ] Clean registry entries
- [ ] Remove scheduled tasks
- [ ] Remove startup programs
- [ ] Verify clean state

### 11. System Hardening
- [ ] Update antivirus definitions
- [ ] Review and update EDR rules
- [ ] Verify system patches are current
- [ ] Review security configurations
- [ ] Enable additional monitoring

### 12. User Account Review
- [ ] Review user account for compromise
- [ ] Force password reset
- [ ] Review account permissions
- [ ] Check for unauthorized access
- [ ] Document account status

### 13. IOC Documentation
- [ ] Document all IOCs:
  - File hashes
  - C2 IPs/domains
  - Registry keys
  - File paths
  - Process names
- [ ] Share IOCs with security team
- [ ] Update threat intelligence feeds

---

## Escalation Criteria

**Escalate to Security Team Lead if:**
- Multiple endpoints affected
- Data exfiltration detected
- Lateral movement confirmed
- Advanced malware (APT)
- Critical system affected

**Escalate to Incident Response if:**
- Confirmed data breach
- Production systems compromised
- Customer data at risk
- Regulatory compliance impact
- Advanced persistent threat (APT)

---

## Ticket Documentation

### Required Fields:
- **Incident ID:** [ID]
- **Severity:** [Level]
- **Status:** [Open/In Progress/Resolved]
- **Endpoint(s):** [List]
- **File Hash:** [Hash]
- **Malware Family:** [If known]
- **IOCs:** [List]
- **Actions Taken:** [List]
- **Resolution:** [Summary]

### Template:
```
MALWARE INCIDENT: [ID]
SEVERITY: [Level]
STATUS: [Status]

SUMMARY:
[One sentence description]

INVESTIGATION:
- Endpoint: [Hostname]
- File: [Filename] (Hash: [SHA256])
- Detection: [Engine/Name]
- VirusTotal: [X/Y engines flagged]
- C2 IPs: [List]
- Behavior: [Key behaviors observed]

IOCs:
- File Hash: [SHA256]
- C2 IPs: [List]
- C2 Domains: [List]
- Registry Keys: [List]

ACTIONS:
- [Action 1]
- [Action 2]
- [Action 3]

RESOLUTION:
[Brief resolution summary]
```

---

## Prevention Recommendations

### Immediate:
- Update antivirus/EDR definitions
- Review email security (common delivery vector)
- User security awareness training

### Short-term:
- Implement application whitelisting
- Strengthen email attachment filtering
- Deploy network segmentation

### Long-term:
- Regular security awareness training
- Phishing simulation exercises
- Enhanced endpoint monitoring
- Threat hunting exercises

---

## References
- [Malware Casefile Example](../003-Malware-EDR-Alert/)
- [Threat Intelligence Project](../../Threat-Intelligence/)
- [Malware Analysis Project](../../Malware-Analysis/)

---

**Last Updated:** [Date]  
**Version:** 1.0
